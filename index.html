<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>出羽鯖 総合申請ポータル</title>
  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f7f6; color: #333; }
    .container { max-width: 700px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

    /* タブメニュー */
    .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; }
    .tab {
      flex: 1; padding: 12px; text-align: center; cursor: pointer;
      background: #f8f9fa; border-radius: 8px 8px 0 0; font-weight: bold; transition: 0.3s;
    }
    .tab.active { background: #2ecc71; color: white; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* 通知・ステータス表示 */
    .notice { background-color: #fff3cd; border-left: 5px solid #ffca28; padding: 15px; margin-bottom: 20px; font-size: 0.9em; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }
    .status-vacant { background: #d4edda; color: #155724; } /* 空車 */
    .status-busy { background: #f8d7da; color: #721c24; }   /* 貸出中 */

    h1 { color: #2c3e50; font-size: 1.5em; border-bottom: 2px solid #2ecc71; padding-bottom: 10px; margin-top: 0; }
    label { font-weight: bold; display: block; margin-top: 15px; }
    input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }

    button { width: 100%; margin-top: 25px; padding: 14px; cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 1em; transition: 0.3s; }
    button:hover { background: #27ae60; }
    button:disabled { background: #ccc; cursor: not-allowed; }

    /* テーブル */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
    th { background: #f8f9fa; color: #666; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="build">建築申請</div>
      <div class="tab" data-tab="rentcar">レンタカー申請</div>
      <div class="tab" data-tab="status">車両状況</div>
    </div>

    <div id="build" class="tab-content active">
      <h1>建築申請フォーム</h1>
      <div class="notice">申請後、運営の許可を待たずに建築を開始できます。</div>
      <form id="requestForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>種類</label>
        <select name="type">
          <option value="建物">建物</option>
          <option value="道路">道路</option>
          <option value="その他">その他</option>
        </select>
        <label>用途</label><input type="text" name="purpose" required>
        <label>中心座標</label><input type="text" name="coords" placeholder="x, y, z" required>
        <button type="submit" id="submitBtn">申請して建築を開始する</button>
      </form>
    </div>

    <div id="rentcar" class="tab-content">
      <h1>レンタカー申請</h1>
      <form id="rentForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>車両選択（貸出中は選択不可）</label>
        <select name="number" id="carNumberSelect"></select>
        <button type="submit" id="rentBtn">この車両を借りる</button>
      </form>
    </div>

    <div id="status" class="tab-content">
      <h1>車両貸出状況</h1>
      <table id="statusTable">
        <thead>
          <tr><th>ナンバー</th><th>車種</th><th>状況</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="fetchCarData()" style="background:#3498db; margin-top:15px;">情報を更新する</button>
    </div>
  </div>

  <script>
    const GAS_URL = "あなたのデプロイURLをここに貼る";

    // タブ切り替え
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab, .tab-content").forEach(el => el.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    // 車両データ取得と反映
    function fetchCarData() {
      const select = document.getElementById("carNumberSelect");
      const tableBody = document.querySelector("#statusTable tbody");
      
      tableBody.innerHTML = "<tr><td colspan='3'>読み込み中...</td></tr>";

      fetch(GAS_URL + "?mode=carlist")
        .then(res => res.json())
        .then(list => {
          select.innerHTML = "";
          tableBody.innerHTML = "";
          
          list.forEach(item => {
            // プルダウン更新
            const opt = document.createElement("option");
            opt.value = item.number;
            opt.textContent = `${item.number} : ${item.car} (${item.price}円)`;
            if (item.status === "貸出中") {
              opt.disabled = true;
              opt.textContent += " [貸出中]";
            }
            select.appendChild(opt);

            // テーブル更新
            const tr = document.createElement("tr");
            const sClass = item.status === "空車" ? "status-vacant" : "status-busy";
            tr.innerHTML = `<td>${item.number}</td><td>${item.car}</td><td><span class="status-badge ${sClass}">${item.status}</span></td>`;
            tableBody.appendChild(tr);
          });
        });
    }

    // フォーム送信処理 (建築)
    document.getElementById('requestForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      const data = new URLSearchParams(new FormData(this));
      data.append('mode', 'build');

      fetch(GAS_URL, { method: 'POST', body: data }).then(() => {
        alert("申請完了！");
        this.reset();
        btn.disabled = false;
      });
    });

    // フォーム送信処理 (レンタカー)
    document.getElementById('rentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const btn = document.getElementById('rentBtn');
      btn.disabled = true;
      const data = new URLSearchParams(new FormData(this));
      data.append('mode', 'rent');

      fetch(GAS_URL, { method: 'POST', body: data }).then(() => {
        alert("貸出処理が完了しました！");
        this.reset();
        btn.disabled = false;
        fetchCarData(); // 状況を再読み込み
      });
    });

    // 初期読み込み
    fetchCarData();
  </script>
</body>
</html>

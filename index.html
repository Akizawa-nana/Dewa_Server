<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‡ºç¾½é¯– - ç”³è«‹ãƒãƒ¼ã‚¿ãƒ«</title>
  
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* é€ä¿¡ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #loading-overlay {
      display: none; 
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9);
      z-index: 10000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Noto Sans JP', sans-serif;
    }

    .loading-img {
      width: 150px; height: auto;
      animation: sui-bounce 1.5s infinite ease-in-out;
    }

    .loading-text {
      margin-top: 20px;
      font-size: 1.2em;
      font-weight: bold;
      color: #e91e63;
      text-align: center;
    }

    @keyframes sui-bounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-20px) scale(1.05); }
    }

    /* è¿½åŠ ï¼šå ±å‘Šãƒ•ã‚©ãƒ¼ãƒ ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      font-size: 0.9em;
    }
    .theme-akita label { color: var(--akita-gold); }
    
    textarea {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      resize: vertical;
    }
    .theme-akita textarea {
      background: #0d1117;
      border-color: #30363d;
      color: white;
    }
    
    .field-group {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="theme-clean">

  <div id="loading-overlay">
    <img src="https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png" alt="ã™ã„ã¡ã‚ƒã‚“" class="loading-img">
    <div class="loading-text">é€ä¿¡ä¸­ã ã™ãƒï¼<br>ã¡ã‚‡ã£ã¨ã ã‘å¾…ã£ã¦ã­...</div>
  </div>

  <div class="theme-switcher"><button class="theme-btn" onclick="toggleTheme()">ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ</button></div>

  <div class="container">
    <div id="header-area">
      <div class="header theme-only-akita" style="display:none; text-align: center; margin-bottom: 20px; border-bottom: 3px double var(--akita-gold);"><h1>å‡ºç¾½é¯– - ç§‹ç”°ãƒãƒ¼ã‚¿ãƒ«</h1></div>
      <div class="header-title theme-only-clean" style="text-align: center; font-size: 1.6em; font-weight: bold; margin-bottom: 25px;">
        å‡ºç¾½é¯– ç·åˆç”³è«‹ãƒãƒ¼ã‚¿ãƒ«<span class="snow-icon"></span>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="build">å»ºç¯‰ç”³è«‹</div>
      <div class="tab" data-tab="rentcar">è»Šä¸¡ãƒ¬ãƒ³ã‚¿ãƒ«</div>
      <div class="tab" data-tab="returncar">è¿”å´ãƒ»ç²¾ç®—</div>
      <div class="tab" data-tab="status">è²¸å‡ºçŠ¶æ³</div>
      <div class="tab" data-tab="manage">ç®¡ç†ãƒ»å ±å‘Š</div> </div>

    <div id="build" class="tab-content active">
      <h2>å»ºç¯‰ç”³è«‹æ›¸</h2>
      <form id="buildForm">
        <label>MCID</label>
        <input type="text" name="mcid" placeholder="ä¾‹: Akita_Taro" required>
        <label>å»ºç¯‰ç¨®åˆ¥</label>
        <select name="type">
          <option>å»ºç‰©</option>
          <option>é“è·¯</option>
          <option>ãã®ä»–</option>
        </select>
        <label>ç”¨é€”</label>
        <input type="text" name="purpose" placeholder="ä¾‹: ãã‚ŠãŸã‚“ã½å±‹" required>
        <label>ä¸­å¿ƒåº§æ¨™</label>
        <input type="text" name="coords" placeholder="ä¾‹: 100, 64, -200" required>
        <button type="submit" class="main-submit">ç”³è«‹ã‚’æå‡ºã™ã‚‹</button>
      </form>
    </div>

    <div id="rentcar" class="tab-content">
      <h2>è»Šä¸¡ãƒ¬ãƒ³ã‚¿ãƒ«</h2>
      <form id="rentForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label><select name="number" id="carSelect"><option>èª­ã¿è¾¼ã¿ä¸­...</option></select>
        <button type="submit" class="main-submit">ãƒ¬ãƒ³ã‚¿ãƒ«ã‚’é–‹å§‹ã™ã‚‹</button>
      </form>
    </div>

    <div id="returncar" class="tab-content">
      <h2>è¿”å´ãƒ»æ–™é‡‘ç²¾ç®—</h2>
      <form id="returnForm">
        <label>MCIDï¼ˆæœ¬äººç¢ºèªï¼‰</label><input type="text" id="returnMcid" required>
        <label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label><select id="returnCarSelect"></select>
        <button type="button" class="main-submit" onclick="calculateFee()" style="margin-top:10px;">æ–™é‡‘ç®—å‡º</button>
        <div id="calcResult" style="display:none; margin-top:15px; padding:15px; border:1px solid #ddd;">
          <div id="feeDetail"></div><div id="feeTotal" style="font-size:1.4em; font-weight:bold; color:var(--sui-pink);"></div>
          <button type="submit" class="main-submit" style="background:var(--sui-pink);">è¿”å´ç¢ºå®š</button>
        </div>
      </form>
    </div>

    <div id="status" class="tab-content">
      <h2>ç¾åœ¨è²¸å‡ºçŠ¶æ³</h2>
      <table><thead><tr><th>ç•ªå·</th><th>è»Šç¨®</th><th>çŠ¶æ…‹</th></tr></thead><tbody id="statusTable"></tbody></table>
    </div>

    <div id="manage" class="tab-content">
      <h2>ç®¡ç†ãƒ»å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ </h2>
      <form id="manageForm">
        <label>MCID</label>
        <input type="text" name="mcid" placeholder="ã‚ãªãŸã®MCID" required>

        <label>å ±å‘Šç¨®åˆ¥</label>
        <select name="reportType" id="reportType" onchange="toggleManageFields()">
          <option value="build_info">å»ºç¯‰ãƒ»åœŸåœ°é–¢é€£ã®å ±å‘Š</option>
          <option value="accident">äº‹æ•…ãƒ»è»Šä¸¡ç ´æã®å ±å‘Š</option>
          <option value="other">ãã®ä»–ãŠå•ã„åˆã‚ã›</option>
        </select>

        <div id="buildFields" class="field-group">
          <label>å¯¾è±¡ã®åº§æ¨™</label>
          <input type="text" name="targetCoords" placeholder="ä¾‹: 100, 64, -200">
        </div>

        <div id="carFields" class="field-group" style="display:none;">
          <label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label>
          <input type="text" name="carNumber" placeholder="ä¾‹: A-01">
        </div>

        <label>è©³ç´°å†…å®¹</label>
        <textarea name="detail" rows="4" placeholder="è©³ã—ã„çŠ¶æ³ã‚’æ•™ãˆã¦ãã ã•ã„ã ã™ãƒï¼" required></textarea>

        <button type="submit" class="main-submit">å ±å‘Šã‚’é€ä¿¡ã™ã‚‹</button>
      </form>
    </div>
  </div>

  <div id="chat-container">
    <div id="chat-bubble" onclick="toggleChat()">
      <img src="https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png" alt="ã™ã„ã¡ã‚ƒã‚“">
    </div>
    <div id="chat-window">
      <div id="chat-header"><span>å‡ºç¾½é¯–ã‚¬ã‚¤ãƒ‰ã€Œé»„æ¡œã™ã„ã€</span><span onclick="toggleChat()" style="cursor:pointer">Ã—</span></div>
      <div id="chat-content">
        <div class="msg-container">
          <img src="https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png" class="bot-icon">
          <div class="msg msg-bot">å‡ºç¾½é¯–ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ï¼ä½¿ã„æ–¹ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™ãƒï½ã€‚</div>
        </div>
        <div id="faq-area" style="margin-left:53px;"></div>
      </div>
      <div class="chat-footer">
        <div class="input-row">
          <input type="text" id="userInput" placeholder="è³ªå•ã‚’å…¥åŠ›...">
          <button class="send-btn" onclick="handleSend()">â–²</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzh3BU8YQ2oHcuWT3CW96_k-OxbGICrxfaMUegU6K1O5e-GWJe_vYysqV_llFIuPZMP/exec";
    const SUI_IMG = "https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png";
    let currentRentData = [];
    let currentFaqData = [];

    function toggleLoading(show) {
      document.getElementById("loading-overlay").style.display = show ? "flex" : "none";
    }

    // å ±å‘Šãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›é …ç›®åˆ‡ã‚Šæ›¿ãˆ
    function toggleManageFields() {
      const type = document.getElementById("reportType").value;
      document.getElementById("buildFields").style.display = (type === "build_info" || type === "other") ? "block" : "none";
      document.getElementById("carFields").style.display = (type === "accident") ? "block" : "none";
    }

    function loadData() {
      fetch(GAS_URL + "?mode=carlist").then(res => res.json()).then(list => {
        currentRentData = list;
        const s1 = document.getElementById("carSelect"); const s2 = document.getElementById("returnCarSelect"); const tb = document.getElementById("statusTable");
        s1.innerHTML = ""; s2.innerHTML = ""; tb.innerHTML = "";
        list.forEach(item => {
          if(item.status === "è²¸å‡ºä¸­") s2.innerHTML += `<option value="${item.number}">${item.number} (${item.car})</option>`;
          else s1.innerHTML += `<option value="${item.number}">${item.number} (${item.car}) - ${item.price}å††</option>`;
          tb.innerHTML += `<tr><td>${item.number}</td><td>${item.car}</td><td><span class="status-badge ${item.status==='è²¸å‡ºä¸­'?'status-busy':'status-vacant'}">${item.status}</span></td></tr>`;
        });
      });
      fetch(GAS_URL + "?mode=faqlist").then(res => res.json()).then(faqs => { currentFaqData = faqs; showFaqMenu(); });
    }

    function toggleChat() {
      const win = document.getElementById('chat-window');
      const bubble = document.getElementById('chat-bubble');
      const isOpen = (win.style.display === 'none' || win.style.display === '');
      win.style.display = isOpen ? 'flex' : 'none';
      if (isOpen) { bubble.classList.add('chat-open'); scrollToBottom(); } else { bubble.classList.remove('chat-open'); }
    }

    function showFaqMenu(targetContainer = null) {
      const area = targetContainer || document.getElementById("faq-area");
      area.innerHTML = "";
      const categories = [...new Set(currentFaqData.map(f => f.category || "ãã®ä»–"))];
      categories.forEach(cat => {
        const b = document.createElement("button");
        b.className = "faq-btn category-btn";
        b.textContent = "ğŸ“ " + cat;
        b.onclick = () => showQuestionsByCategory(cat, targetContainer);
        area.appendChild(b);
      });
      scrollToBottom();
    }

    function showQuestionsByCategory(cat, targetContainer) {
      const area = targetContainer || document.getElementById("faq-area");
      area.innerHTML = `<div style="padding:5px; font-size:0.8em; color:#888; border-left:3px solid var(--sui-pink); margin-bottom:5px;">${cat}</div>`;
      currentFaqData.filter(f => (f.category || "ãã®ä»–") === cat).forEach(f => {
        const b = document.createElement("button");
        b.className = "faq-btn"; b.textContent = "ğŸ“‹ " + f.question;
        b.onclick = () => askChat(f.question);
        area.appendChild(b);
      });
      const back = document.createElement("button");
      back.className = "back-btn"; back.textContent = "â† åˆ†é¡ä¸€è¦§ã¸";
      back.onclick = () => showFaqMenu(targetContainer);
      area.appendChild(back);
      scrollToBottom();
    }

    function askChat(q) {
      const content = document.getElementById('chat-content');
      document.getElementById("faq-area").innerHTML = "";
      content.innerHTML += `<div style="width:100%; display:flex; margin-bottom:10px;"><div class="msg msg-user">${q}</div></div>`;
      const faq = currentFaqData.find(f => f.question === q);
      setTimeout(() => {
        const responseId = "res-" + Date.now();
        content.innerHTML += `
          <div class="msg-container" style="display:flex; align-items:flex-start;">
            <img src="${SUI_IMG}" class="bot-icon">
            <div class="msg msg-bot">${faq ? faq.answer : 'ã™ã¿ã¾ã›ã‚“ã€ã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'}</div>
          </div>
          <div id="${responseId}" style="margin-left:53px; margin-bottom:20px;"></div>
        `;
        addBackButton(responseId);
        scrollToBottom();
      }, 600);
    }

    function handleSend() {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if(!text) return;
      const content = document.getElementById('chat-content');
      content.innerHTML += `<div style="width:100%; display:flex; margin-bottom:10px;"><div class="msg msg-user">${text}</div></div>`;
      input.value = "";
      setTimeout(() => {
        const responseId = "res-send-" + Date.now();
        content.innerHTML += `
          <div class="msg-container" style="display:flex; align-items:flex-start;">
            <img src="${SUI_IMG}" class="bot-icon">
            <div class="msg msg-bot">ã€Œ${text}ã€ã§ã™ã­ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é¸ã¶ã‹ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠå°‹ã­ãã ã•ã„ï¼</div>
          </div>
          <div id="${responseId}" style="margin-left:53px; margin-bottom:20px;"></div>
        `;
        addBackButton(responseId);
        scrollToBottom();
      }, 800);
    }

    function addBackButton(targetId) {
      const nextArea = document.getElementById(targetId);
      const backBtn = document.createElement("button");
      backBtn.className = "back-btn"; backBtn.textContent = "â† ä»–ã®è³ªå•ã‚’ã™ã‚‹";
      backBtn.onclick = () => { backBtn.remove(); showFaqMenu(nextArea); };
      nextArea.appendChild(backBtn);
    }

    function scrollToBottom() { const c = document.getElementById('chat-content'); c.scrollTop = c.scrollHeight; }

    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab, .tab-content").forEach(el => el.classList.remove("active"));
        tab.classList.add("active"); document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    function toggleTheme() {
      document.body.classList.toggle('theme-clean');
      document.body.classList.toggle('theme-akita');
      localStorage.setItem('selectedTheme', document.body.classList.contains('theme-akita') ? 'theme-akita' : 'theme-clean');
      updateThemeUI();
    }

    function loadTheme() {
      if (localStorage.getItem('selectedTheme') === 'theme-akita') {
        document.body.classList.remove('theme-clean'); document.body.classList.add('theme-akita');
      }
      updateThemeUI();
    }

    function updateThemeUI() {
      const isAkita = document.body.classList.contains('theme-akita');
      document.querySelectorAll('.theme-only-akita').forEach(e => e.style.display = isAkita ? 'block' : 'none');
      document.querySelectorAll('.theme-only-clean').forEach(e => e.style.display = isAkita ? 'none' : 'block');
    }

    function calculateFee() {
      const m = document.getElementById("returnMcid").value; const n = document.getElementById("returnCarSelect").value;
      const t = currentRentData.find(i => i.number == n);
      if(t && t.mcid === m) {
        const days = Math.max(1, Math.ceil(Math.abs(new Date() - new Date(t.lastDate))/(1000*60*60*24)));
        document.getElementById("feeDetail").innerHTML = `è»Šç¨®: ${t.car}<br>æœŸé–“: ${days}æ—¥é–“`;
        document.getElementById("feeTotal").innerText = `åˆè¨ˆ: ${days * t.price}å††`;
        document.getElementById("calcResult").style.display = "block";
      } else { alert("MCIDãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚"); }
    }

    // --- é€ä¿¡å‡¦ç† ---

    // 1. å»ºç¯‰ç”³è«‹
    document.getElementById("buildForm").onsubmit = function(e) { 
      e.preventDefault(); toggleLoading(true);
      const p = new URLSearchParams(new FormData(this)); p.append("mode", "build");
      fetch(GAS_URL, { method: "POST", body: p, mode: "no-cors" }).then(() => {
        toggleLoading(false); alert("å»ºç¯‰ç”³è«‹ã‚’æå‡ºã—ã¾ã—ãŸï¼ã™ãã«å»ºç¯‰ã‚’å§‹ã‚ã¦OKã ã™ãƒï¼"); this.reset();
      }).catch(() => { toggleLoading(false); alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); });
    };

    // 2. ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹
    document.getElementById("rentForm").onsubmit = function(e) { 
      e.preventDefault(); toggleLoading(true);
      const p = new URLSearchParams(new FormData(this)); p.append("mode","rent"); 
      fetch(GAS_URL, {method:"POST", body:p}).then(r=>r.text()).then(t => {
        toggleLoading(false); if(t.includes("Error")) alert("2å°ã¾ã§ã§ã™"); else { alert("ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹ï¼"); location.reload(); }
      }).catch(() => { toggleLoading(false); alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼"); });
    };

    // 3. è¿”å´ç¢ºå®š
    document.getElementById("returnForm").onsubmit = function(e) { 
      e.preventDefault(); toggleLoading(true);
      const p = new URLSearchParams(); p.append("mode","return"); p.append("mcid", document.getElementById("returnMcid").value); p.append("number", document.getElementById("returnCarSelect").value); 
      fetch(GAS_URL, {method:"POST", body:p}).then(() => { toggleLoading(false); alert("è¿”å´å®Œäº†ï¼"); location.reload(); }).catch(() => { toggleLoading(false); alert("ã‚¨ãƒ©ãƒ¼"); });
    };

    // è¿½åŠ ï¼š4. ç®¡ç†å ±å‘Šé€ä¿¡
    document.getElementById("manageForm").onsubmit = function(e) {
      e.preventDefault(); toggleLoading(true);
      const p = new URLSearchParams(new FormData(this)); p.append("mode", "manage");
      fetch(GAS_URL, { method: "POST", body: p, mode: "no-cors" }).then(() => {
        toggleLoading(false); alert("å ±å‘Šã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚é‹å–¶ãŒç¢ºèªã™ã‚‹ã ã™ãƒï¼"); this.reset(); toggleManageFields();
      }).catch(() => { toggleLoading(false); alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼"); });
    };

    document.getElementById("userInput").onkeypress = (e) => { if(e.key==="Enter") handleSend(); };
    loadTheme(); loadData();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‡ºç¾½é¯– - ç”³è«‹ãƒãƒ¼ã‚¿ãƒ«</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">

  <style id="theme-styles">
    /* --- åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ --- */
    .theme-switcher { position: fixed; top: 8px; right: 8px; z-index: 9999; }
    .theme-btn { padding: 3px 8px; cursor: pointer; font-size: 0.7em; border-radius: 3px; transition: 0.3s; opacity: 0.4; background: transparent; border: 1px solid #ccc; color: #888; }
    .theme-btn:hover { opacity: 1; }

    /* --- ç§‹ç”°ãƒ¢ãƒ€ãƒ³ ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆtheme-akitaï¼‰ --- */
    :root {
      --akita-red: #c0392b; --akita-gold: #d4af37; --akita-cedar: #1b2e1b;
      --akita-sea: #0f172a; --bg-color: #0d1117; --card-bg: #161b22;
      --text-color: #f0f6fc; --border-color: #30363d; --status-vacant: #2ea043;
    }

    body.theme-akita {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
      background-color: var(--akita-cedar); background-image: linear-gradient(180deg, var(--akita-cedar) 0%, var(--bg-color) 100%);
      color: var(--text-color); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px;
    }
    .theme-akita .container { width: 100%; max-width: 800px; animation: fadeIn 0.8s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .theme-akita .header { text-align: center; padding: 30px 0; border-bottom: 3px double var(--akita-gold); margin-bottom: 30px; }
    .theme-akita .header h1 { margin: 0; font-size: 2.2em; color: var(--akita-gold); text-shadow: 2px 2px 4px rgba(0,0,0,0.8); letter-spacing: 4px; }
    .theme-akita .tab { padding: 12px 20px; cursor: pointer; background: var(--akita-sea); border: 1px solid var(--akita-gold); border-radius: 4px; color: var(--akita-gold); font-weight: bold; flex: 1; text-align: center; }
    .theme-akita .tab.active { background: var(--akita-gold); color: var(--akita-cedar); }
    .theme-akita .tab-content { display: none; background: var(--card-bg); padding: 30px; border-radius: 8px; border: 1px solid var(--border-color); }
    .theme-akita .tab-content.active { display: block; }
    .theme-akita input, .theme-akita select { width: 100%; padding: 12px; margin-top: 8px; background: #0d1117; border: 1px solid var(--border-color); color: #fff; box-sizing: border-box;}
    .theme-akita button { width: 100%; margin-top: 30px; padding: 15px; background: var(--akita-red); color: white; border: none; font-weight: bold; cursor: pointer; }
    .theme-akita table { width: 100%; border-collapse: collapse; }
    .theme-akita th { border-bottom: 2px solid var(--akita-gold); color: var(--akita-gold); padding: 10px; text-align: left;}

    /* --- ç·åˆç”³è«‹ãƒãƒ¼ã‚¿ãƒ«ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ãƒ»theme-cleanï¼‰ --- */
    body.theme-clean { font-family: "Noto Sans JP", sans-serif; background: #f3f6fb; color: #1c2a44; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
    .theme-clean .container { max-width: 720px; width: 100%; margin: 20px auto; background: #ffffff; padding: 35px; border: 1px solid #e1e6ef; box-shadow: 0 8px 25px rgba(20, 30, 60, 0.05); }
    .theme-clean .header-title { text-align: center; font-size: 1.5em; font-weight: 700; margin-bottom: 30px; }
    .theme-clean .tab { flex: 1; text-align: center; padding: 14px; cursor: pointer; font-weight: 600; color: #1c2a44; border-bottom: 3px solid transparent;}
    .theme-clean .tab.active { color: #8c1f28; border-bottom: 3px solid #8c1f28; }
    .theme-clean .tab-content { display: none; }
    .theme-clean .tab-content.active { display: block; }
    .theme-clean input, .theme-clean select { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #d4dae6; background: #f9fbff; box-sizing: border-box;}
    .theme-clean button { width: 100%; margin-top: 28px; padding: 14px; background: #1c2a44; color: #ffffff; border: none; cursor: pointer; }

    /* --- å…±é€šãƒ‘ãƒ¼ãƒ„ --- */
    .tabs { display: flex; gap: 5px; margin-bottom: 25px; }
    .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
    .status-vacant { background: #e6f0ff; color: #1c2a44; }
    .status-busy { background: #f8e6e6; color: #8c1f28; }
    #calcResult { margin-top: 20px; padding: 18px; background: rgba(128,128,128,0.1); border: 1px solid #ccc; display: none; }

    /* --- ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚¹ã‚¿ã‚¤ãƒ« --- */
    #chat-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; font-family: sans-serif; }
    #chat-bubble { width: 60px; height: 60px; background: #1c2a44; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); color: white; font-size: 24px; transition: 0.3s; }
    .theme-akita #chat-bubble { background: var(--akita-red); border: 1px solid var(--akita-gold); }
    #chat-window { display: none; width: 300px; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 25px rgba(0,0,0,0.2); margin-bottom: 15px; border: 1px solid #ddd; }
    #chat-header { background: #1c2a44; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
    .theme-akita #chat-header { background: var(--akita-cedar); border-bottom: 1px solid var(--akita-gold); color: var(--akita-gold); }
    #chat-content { height: 350px; overflow-y: auto; padding: 15px; background: #f9fbff; }
    .theme-akita #chat-content { background: #0d1117; color: white; }
    .faq-btn { width: 100%; padding: 8px; margin: 4px 0; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; font-size: 0.85em; text-align: left; transition: 0.2s; }
    .faq-btn:hover { background: #f0f4fa; }
    .theme-akita .faq-btn { background: #161b22; color: var(--akita-gold); border-color: var(--akita-gold); }
    .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; font-size: 0.85em; line-height: 1.4; display: inline-block; max-width: 80%; }
    .msg-bot { background: #eef3fb; color: #333; border-radius: 15px 15px 15px 0; }
    .theme-akita .msg-bot { background: #30363d; color: white; }
    .msg-user { background: #1c2a44; color: white; border-radius: 15px 15px 0 15px; float: right; }
    .theme-akita .msg-user { background: var(--akita-red); }
  </style>
</head>

<body class="theme-clean">

  <div class="theme-switcher">
    <button class="theme-btn" onclick="toggleTheme()">ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ</button>
  </div>

  <div class="container">
    <div id="header-area">
      <div class="header theme-only-akita" style="display:none;">
        <h1>å‡ºç¾½é¯– - ç§‹ç”°ãƒãƒ¼ã‚¿ãƒ«</h1>
      </div>
      <div class="header-title theme-only-clean">å‡ºç¾½é¯– ç·åˆç”³è«‹ãƒãƒ¼ã‚¿ãƒ«</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="build">å»ºç¯‰ç”³è«‹</div>
      <div class="tab" data-tab="rentcar">è»Šä¸¡ãƒ¬ãƒ³ã‚¿ãƒ«</div>
      <div class="tab" data-tab="returncar">è¿”å´ãƒ»ç²¾ç®—</div>
      <div class="tab" data-tab="status">è²¸å‡ºçŠ¶æ³</div>
    </div>

    <div id="build" class="tab-content active">
      <h1>å»ºç¯‰ç”³è«‹æ›¸</h1>
      <form id="buildForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>å»ºç¯‰ç¨®åˆ¥</label>
        <select name="type"><option value="å»ºç‰©">å»ºç‰©</option><option value="é“è·¯">é“è·¯</option><option value="ãã®ä»–">ãã®ä»–</option></select>
        <label>ç”¨é€”</label><input type="text" name="purpose" required>
        <label>ä¸­å¿ƒåº§æ¨™</label><input type="text" name="coords" required>
        <button type="submit">ç”³è«‹æå‡º</button>
      </form>
    </div>

    <div id="rentcar" class="tab-content">
      <h1>è»Šä¸¡ãƒ¬ãƒ³ã‚¿ãƒ«</h1>
      <form id="rentForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label><select name="number" id="carSelect"></select>
        <button type="submit">ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹</button>
      </form>
    </div>

    <div id="returncar" class="tab-content">
      <h1>è¿”å´ãƒ»æ–™é‡‘ç²¾ç®—</h1>
      <form id="returnForm">
        <label>MCIDï¼ˆæœ¬äººç¢ºèªï¼‰</label><input type="text" id="returnMcid" placeholder="è²¸å‡ºæ™‚ã®MCIDã‚’å…¥åŠ›" required>
        <label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label><select name="number" id="returnCarSelect"></select>
        <button type="button" onclick="calculateFee()">æ–™é‡‘ç®—å‡ºãƒ»æœ¬äººç¢ºèª</button>
        <div id="calcResult">
          <div id="feeDetail"></div>
          <div id="feeTotal" style="font-size:1.3em; font-weight:bold;"></div>
        </div>
        <button type="submit" id="returnBtn" style="display:none;">è¿”å´ç¢ºå®š</button>
      </form>
    </div>

    <div id="status" class="tab-content">
      <h1>ç¾åœ¨è²¸å‡ºçŠ¶æ³</h1>
      <table>
        <thead><tr><th>ç•ªå·</th><th>è»Šç¨®</th><th>çŠ¶æ…‹</th></tr></thead>
        <tbody id="statusTable"></tbody>
      </table>
    </div>
  </div>

  <div id="chat-container">
    <div id="chat-bubble" onclick="toggleChat()">ğŸ’¬</div>
    <div id="chat-window">
      <div id="chat-header">
        <span>å‡ºç¾½é¯– ãƒ˜ãƒ«ãƒ—</span>
        <span style="cursor: pointer;" onclick="toggleChat()">Ã—</span>
      </div>
      <div id="chat-content">
        <div class="msg msg-bot">ã“ã‚“ã«ã¡ã¯ï¼å‡ºç¾½é¯–ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚ä½•ã‹ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ</div>
        <div id="faq-list"></div>
      </div>
    </div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwsq8vd69zZf5FsTUxfa26PS7mB3n8jJEuRJ_Xck68XRZvExMIW3gRxxCDU7KLiyHKH/exec";
let currentRentData = [];
let currentFaqData = [];

/* ã‚¿ãƒ–åˆ‡æ›¿ */
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab, .tab-content").forEach(el => el.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

/* ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ (è»Šä¸¡ãƒªã‚¹ãƒˆ & FAQ) */
function loadData() {
  // è»Šä¸¡ãƒªã‚¹ãƒˆ
  fetch(GAS_URL + "?mode=carlist")
  .then(res => res.json())
  .then(list => {
    currentRentData = list;
    const select = document.getElementById("carSelect");
    const returnSelect = document.getElementById("returnCarSelect");
    const tbody = document.getElementById("statusTable");
    select.innerHTML=""; returnSelect.innerHTML=""; tbody.innerHTML="";
    list.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.number;
      if (item.status === "è²¸å‡ºä¸­") {
        opt.textContent = `${item.number} (${item.car}) è²¸å‡ºä¸­`; opt.disabled = true;
        const optR = document.createElement("option");
        optR.value = item.number; optR.textContent = `${item.number} (${item.car})`;
        returnSelect.appendChild(optR);
      } else {
        opt.textContent = `${item.number} (${item.car}) 1æ—¥:${item.price}å††`;
      }
      select.appendChild(opt);
      const tr = document.createElement("tr");
      const statusClass = (item.status === "è²¸å‡ºä¸­") ? "status-busy" : "status-vacant";
      tr.innerHTML = `<td>${item.number}</td><td>${item.car}</td><td><span class="status-badge ${statusClass}">${item.status}</span></td>`;
      tbody.appendChild(tr);
    });
  });

  // FAQãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
  fetch(GAS_URL + "?mode=faqlist")
  .then(res => res.json())
  .then(faqs => {
    currentFaqData = faqs;
    const faqListDiv = document.getElementById("faq-list");
    faqListDiv.innerHTML = "";
    faqs.forEach(item => {
      const btn = document.createElement("button");
      btn.className = "faq-btn";
      btn.textContent = "â“ " + item.question;
      btn.onclick = () => askChat(item.question);
      faqListDiv.appendChild(btn);
    });
  });
}

/* ãƒãƒ£ãƒƒãƒˆå‡¦ç† */
function toggleChat() {
  const win = document.getElementById('chat-window');
  win.style.display = win.style.display === 'none' ? 'block' : 'none';
}

function askChat(question) {
  const content = document.getElementById('chat-content');
  content.innerHTML += `<div style="width:100%; overflow:hidden;"><div class="msg msg-user">${question}</div></div>`;
  
  const faq = currentFaqData.find(f => f.question === question);
  const answer = faq ? faq.answer : "ãŠç­”ãˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";

  setTimeout(() => {
    content.innerHTML += `<div class="msg msg-bot">${answer}</div>`;
    content.scrollTop = content.scrollHeight;
  }, 500);
}

/* ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ */
function toggleTheme() {
  const body = document.body;
  const akitaHeaders = document.querySelectorAll('.theme-only-akita');
  const cleanHeaders = document.querySelectorAll('.theme-only-clean');
  body.classList.toggle('theme-clean');
  body.classList.toggle('theme-akita');
  const isAkita = body.classList.contains('theme-akita');
  akitaHeaders.forEach(el => el.style.display = isAkita ? 'block' : 'none');
  cleanHeaders.forEach(el => el.style.display = isAkita ? 'none' : 'block');
}

/* å»ºç¯‰ãƒ»ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è¿”å´ã®é€ä¿¡å‡¦ç†(çœç•¥ã›ãšç¶­æŒ) */
document.getElementById("buildForm").onsubmit = function(e) {
  e.preventDefault();
  const data = new URLSearchParams(new FormData(this)); data.append("mode", "build");
  fetch(GAS_URL, { method:"POST", body:data }).then(() => { alert("å»ºç¯‰ç”³è«‹å®Œäº†ï¼"); this.reset(); });
};
document.getElementById("rentForm").onsubmit = function(e) {
  e.preventDefault();
  const data = new URLSearchParams(new FormData(this)); data.append("mode", "rent");
  fetch(GAS_URL, { method:"POST", body:data }).then(res => res.text()).then(res => {
    if(res.includes("Error")) alert("åŒæ™‚ãƒ¬ãƒ³ã‚¿ãƒ«ã¯2å°ã¾ã§ã§ã™ã€‚");
    else { alert("ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹ï¼"); this.reset(); loadData(); }
  });
};
document.getElementById("returnForm").onsubmit = function(e) {
  e.preventDefault();
  const data = new URLSearchParams(new FormData(this)); data.append("mode", "return");
  fetch(GAS_URL, { method:"POST", body:data }).then(() => { alert("è¿”å´å®Œäº†ï¼"); this.reset(); loadData(); });
};
function calculateFee() {
  const mcid = document.getElementById("returnMcid").value.trim();
  const num = document.getElementById("returnCarSelect").value;
  const target = currentRentData.find(i => i.number == num);
  if (target && target.mcid === mcid) {
    const days = Math.max(1, Math.ceil(Math.abs(new Date() - new Date(target.lastDate))/(1000*60*60*24)));
    document.getElementById("feeDetail").innerHTML = `å€Ÿå—äºº: ${target.mcid}<br>è»Šç¨®: ${target.car} / ${days}æ—¥åˆ©ç”¨`;
    document.getElementById("feeTotal").innerText = `åˆè¨ˆ: ${days * target.price}å††`;
    document.getElementById("calcResult").style.display="block";
    document.getElementById("returnBtn").style.display="block";
  } else { alert("MCIDãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚"); }
}

loadData();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‡ºç¾½é¯– - ç”³è«‹ãƒãƒ¼ã‚¿ãƒ«</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style id="theme-styles">
    /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
    :root {
      --akita-red: #c0392b; --akita-gold: #d4af37; --akita-cedar: #1b2e1b;
      --akita-sea: #0f172a; --bg-color: #0d1117; --card-bg: #161b22;
      --text-color: #f0f6fc; --border-color: #30363d; --status-vacant: #2ea043;
    }
    .theme-switcher { position: fixed; top: 8px; right: 8px; z-index: 9999; }
    .theme-btn { padding: 3px 8px; cursor: pointer; font-size: 0.7em; border-radius: 3px; transition: 0.3s; opacity: 0.4; background: transparent; border: 1px solid #ccc; color: #888; }
    .theme-btn:hover { opacity: 1; }

    /* --- ç§‹ç”°ãƒ¢ãƒ€ãƒ³ --- */
    body.theme-akita { font-family: sans-serif; background-color: var(--akita-cedar); background-image: linear-gradient(180deg, var(--akita-cedar) 0%, var(--bg-color) 100%); color: var(--text-color); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
    .theme-akita .container { width: 100%; max-width: 800px; }
    .theme-akita .header { text-align: center; padding: 30px 0; border-bottom: 3px double var(--akita-gold); margin-bottom: 30px; }
    .theme-akita .header h1 { color: var(--akita-gold); letter-spacing: 4px; }
    .theme-akita .tab { padding: 12px; cursor: pointer; background: var(--akita-sea); border: 1px solid var(--akita-gold); color: var(--akita-gold); flex: 1; text-align: center; }
    .theme-akita .tab.active { background: var(--akita-gold); color: var(--akita-cedar); }
    .theme-akita .tab-content { display: none; background: var(--card-bg); padding: 30px; border: 1px solid var(--border-color); }
    .theme-akita .tab-content.active { display: block; }
    .theme-akita input, .theme-akita select { width: 100%; padding: 12px; margin-top: 8px; background: #0d1117; border: 1px solid var(--border-color); color: #fff; box-sizing: border-box; }
    .theme-akita button { width: 100%; margin-top: 20px; padding: 15px; background: var(--akita-red); color: white; border: none; font-weight: bold; cursor: pointer; }

    /* --- ã‚¯ãƒªãƒ¼ãƒ³ --- */
    body.theme-clean { font-family: "Noto Sans JP", sans-serif; background: #f3f6fb; color: #1c2a44; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
    .theme-clean .container { max-width: 720px; width: 100%; background: #ffffff; padding: 35px; border: 1px solid #e1e6ef; box-shadow: 0 8px 25px rgba(0,0,0,0.05); }
    .theme-clean .header-title { text-align: center; font-size: 1.5em; font-weight: 700; margin-bottom: 30px; }
    .theme-clean .tabs { display: flex; border-bottom: 2px solid #e3e8f2; margin-bottom: 25px; }
    .theme-clean .tab { flex: 1; text-align: center; padding: 14px; cursor: pointer; font-weight: 600; color: #1c2a44; }
    .theme-clean .tab.active { color: #8c1f28; border-bottom: 3px solid #8c1f28; }
    .theme-clean .tab-content { display: none; }
    .theme-clean .tab-content.active { display: block; }
    .theme-clean input, .theme-clean select { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #d4dae6; background: #f9fbff; box-sizing: border-box; }
    .theme-clean button { width: 100%; margin-top: 20px; padding: 14px; background: #1c2a44; color: white; border: none; cursor: pointer; }

    #calcResult { margin-top: 20px; padding: 20px; border-radius: 4px; display: none; background: #f0f4fa; border: 1px solid #c8a951; }
    .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 0.8em; }
    .status-vacant { background: #e6f0ff; color: #1c2a44; }
    .status-busy { background: #f8e6e6; color: #8c1f28; }
  </style>
</head>
<body class="theme-clean">

  <div class="theme-switcher"><button class="theme-btn" onclick="toggleTheme()">ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ</button></div>

  <div class="container">
    <div id="header-area">
      <div class="header theme-only-akita" style="display:none;"><h1>å‡ºç¾½é¯– - ç§‹ç”°ãƒãƒ¼ã‚¿ãƒ«</h1></div>
      <div class="header-title theme-only-clean">å‡ºç¾½é¯– ç·åˆç”³è«‹ãƒãƒ¼ã‚¿ãƒ«</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="build">å»ºç¯‰ç”³è«‹</div>
      <div class="tab" data-tab="rentcar">è»Šä¸¡ãƒ¬ãƒ³ã‚¿ãƒ«</div>
      <div class="tab" data-tab="returncar">è¿”å´ãƒ»ç²¾ç®—</div>
      <div class="tab" data-tab="status">è²¸å‡ºçŠ¶æ³</div>
    </div>

    <div id="build" class="tab-content active">
      <h2>å»ºç¯‰ç”³è«‹æ›¸</h2>
      <form id="buildForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>å»ºç¯‰ç¨®åˆ¥</label><select name="type"><option>å»ºç‰©</option><option>é“è·¯</option><option>ãã®ä»–</option></select>
        <label>ç”¨é€”</label><input type="text" name="purpose" required>
        <label>ä¸­å¿ƒåº§æ¨™</label><input type="text" name="coords" required>
        <button type="submit">ç”³è«‹æå‡º</button>
      </form>
    </div>

    <div id="rentcar" class="tab-content">
      <h2>è»Šä¸¡ãƒ¬ãƒ³ã‚¿ãƒ«</h2>
      <form id="rentForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label><select name="number" id="carSelect"></select>
        <button type="submit">ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹</button>
      </form>
    </div>

    <div id="returncar" class="tab-content">
      <h2>è¿”å´ãƒ»æ–™é‡‘ç²¾ç®—</h2>
      <form id="returnForm">
        <label>MCIDï¼ˆæœ¬äººç¢ºèªï¼‰</label><input type="text" id="returnMcid" required>
        <label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label><select name="number" id="returnCarSelect"></select>
        <button type="button" onclick="calculateFee()">æ–™é‡‘ç®—å‡º</button>
        <div id="calcResult"><div id="feeDetail"></div><div id="feeTotal" style="font-size:1.2em; font-weight:bold;"></div></div>
        <button type="submit" id="returnBtn" style="display:none;">è¿”å´ã‚’ç¢ºå®šã™ã‚‹</button>
      </form>
    </div>

    <div id="status" class="tab-content">
      <h2>ç¾åœ¨è²¸å‡ºçŠ¶æ³</h2>
      <table width="100%"><thead><tr><th>ç•ªå·</th><th>è»Šç¨®</th><th>çŠ¶æ…‹</th></tr></thead><tbody id="statusTable"></tbody></table>
    </div>
  </div>

  <div id="chat-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 10000;">
    <div id="chat-bubble" onclick="toggleChat()" style="width: 60px; height: 60px; background: #8c1f28; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; font-size: 24px;">ğŸ’¬</div>
    <div id="chat-window" style="display: none; width: 300px; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 25px rgba(0,0,0,0.2); margin-bottom: 15px; border: 1px solid #ddd;">
      <div style="background: #1c2a44; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between;"><span>ãƒ˜ãƒ«ãƒ—ãƒœãƒƒãƒˆ</span><span onclick="toggleChat()" style="cursor:pointer">Ã—</span></div>
      <div id="chat-content" style="height: 300px; overflow-y: auto; padding: 15px; background: #f9fbff; font-size: 0.9em;">
        <div style="background: #eef3fb; padding: 10px; border-radius: 10px; margin-bottom: 10px;">ã”ç”¨ä»¶ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</div>
        <div id="faq-list"></div>
      </div>
    </div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwsq8vd69zZf5FsTUxfa26PS7mB3n8jJEuRJ_Xck68XRZvExMIW3gRxxCDU7KLiyHKH/exec";
let currentRentData = [];
let currentFaqData = [];

/* --- ã‚¿ãƒ–åˆ‡æ›¿ --- */
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab, .tab-content").forEach(el => el.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

/* --- å»ºç¯‰ --- */
document.getElementById("buildForm").addEventListener("submit", function(e) {
  e.preventDefault();
  fetch(GAS_URL, { method:"POST", body: new URLSearchParams(new FormData(this)).append("mode","build") }).then(() => { alert("ç”³è«‹å®Œäº†ï¼"); this.reset(); });
});

/* --- ãƒ¬ãƒ³ã‚¿ãƒ« --- */
document.getElementById("rentForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const data = new URLSearchParams(new FormData(this)); data.append("mode", "rent");
  fetch(GAS_URL, { method:"POST", body:data }).then(res => res.text()).then(res => {
    if(res.includes("Error")) alert("åˆ¶é™ï¼š1äºº2å°ã¾ã§ã§ã™ã€‚"); else { alert("ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹ï¼"); loadData(); }
  });
});

/* --- è¿”å´ --- */
document.getElementById("returnForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const data = new URLSearchParams(); data.append("mode", "return");
  data.append("mcid", document.getElementById("returnMcid").value);
  data.append("number", document.getElementById("returnCarSelect").value);
  fetch(GAS_URL, { method:"POST", body:data }).then(() => { alert("è¿”å´å®Œäº†ï¼"); document.getElementById("returnBtn").style.display="none"; loadData(); });
});

/* --- æ–™é‡‘è¨ˆç®— --- */
function calculateFee() {
  const mcid = document.getElementById("returnMcid").value;
  const num = document.getElementById("returnCarSelect").value;
  const car = currentRentData.find(c => c.number == num);
  if(!mcid || !car || car.mcid !== mcid) { alert("MCIDãŒä¸€è‡´ã—ã¾ã›ã‚“"); return; }
  
  const diff = Math.max(1, Math.ceil(Math.abs(new Date() - new Date(car.lastDate))/(1000*60*60*24)));
  document.getElementById("feeDetail").innerText = `${car.car} / ${diff}æ—¥é–“åˆ©ç”¨`;
  document.getElementById("feeTotal").innerText = `åˆè¨ˆ: ${diff * car.price}å††`;
  document.getElementById("calcResult").style.display = "block";
  document.getElementById("returnBtn").style.display = "block";
}

/* --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ --- */
function loadData() {
  // è»Šä¸¡ãƒªã‚¹ãƒˆ
  fetch(GAS_URL + "?mode=carlist").then(res => res.json()).then(list => {
    currentRentData = list;
    const s1 = document.getElementById("carSelect");
    const s2 = document.getElementById("returnCarSelect");
    const tb = document.getElementById("statusTable");
    s1.innerHTML = ""; s2.innerHTML = ""; tb.innerHTML = "";
    list.forEach(c => {
      const opt = `<option value="${c.number}">${c.number} (${c.car})</option>`;
      if(c.status === "è²¸å‡ºä¸­") { s2.innerHTML += opt; } else { s1.innerHTML += opt; }
      tb.innerHTML += `<tr><td>${c.number}</td><td>${c.car}</td><td><span class="status-badge ${c.status==='è²¸å‡ºä¸­'?'status-busy':'status-vacant'}">${c.status}</span></td></tr>`;
    });
  });
  // FAQãƒªã‚¹ãƒˆ
  fetch(GAS_URL + "?mode=faqlist").then(res => res.json()).then(faqs => {
    currentFaqData = faqs;
    const list = document.getElementById("faq-list");
    list.innerHTML = "";
    faqs.forEach(f => {
      const b = document.createElement("button");
      b.innerText = f.question;
      b.style = "width: 100%; padding: 8px; margin: 4px 0; border: 1px solid #c8a951; border-radius: 20px; background: white; cursor: pointer; text-align: left;";
      b.onclick = () => askChat(f.question);
      list.appendChild(b);
    });
  });
}

/* --- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ --- */
function toggleChat() { 
  const win = document.getElementById('chat-window'); 
  win.style.display = win.style.display === 'none' ? 'block' : 'none'; 
}
function askChat(q) {
  const content = document.getElementById('chat-content');
  content.innerHTML += `<div style="text-align: right; margin-bottom: 10px;"><span style="background: #8c1f28; color: white; padding: 8px; border-radius: 10px;">${q}</span></div>`;
  const f = currentFaqData.find(i => i.question === q);
  setTimeout(() => {
    content.innerHTML += `<div style="margin-bottom: 10px;"><span style="background: #e1e6ef; padding: 8px; border-radius: 10px;">${f ? f.answer : "ä¸æ˜ãªè³ªå•ã§ã™"}</span></div>`;
    content.scrollTop = content.scrollHeight;
  }, 500);
}

function toggleTheme() {
  document.body.classList.toggle('theme-clean');
  document.body.classList.toggle('theme-akita');
  const isAkita = document.body.classList.contains('theme-akita');
  document.querySelector('.theme-only-akita').style.display = isAkita ? 'block' : 'none';
  document.querySelector('.theme-only-clean').style.display = isAkita ? 'none' : 'block';
}

loadData();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‡ºç¾½é¯– - ç”³è«‹ãƒãƒ¼ã‚¿ãƒ«</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- å¤‰æ•°ã¨åŸºæœ¬è¨­å®š --- */
    :root {
      --akita-red: #c0392b; --akita-gold: #d4af37; --akita-cedar: #1b2e1b;
      --akita-sea: #0f172a; --bg-dark: #0d1117; --card-dark: #161b22;
      --clean-bg: #f3f6fb; --clean-main: #1c2a44; --clean-accent: #8c1f28;
      --sui-blue: #bce9fe; --sui-pink: #e91e63;
    }

    body { margin: 0; transition: 0.3s; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    
    /* --- ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ --- */
    .theme-switcher { position: fixed; top: 8px; right: 8px; z-index: 10000; }
    .theme-btn { padding: 4px 10px; cursor: pointer; font-size: 11px; border-radius: 4px; opacity: 0.5; background: #fff; border: 1px solid #ccc; }
    .theme-btn:hover { opacity: 1; }

    /* --- ãƒ‡ã‚¶ã‚¤ãƒ³: ã‚¯ãƒªãƒ¼ãƒ³ --- */
    body.theme-clean { font-family: "Noto Sans JP", sans-serif; background: var(--clean-bg); color: var(--clean-main); }
    .theme-clean .container { max-width: 800px; width: 100%; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    .theme-clean .tab.active { color: var(--clean-accent); border-bottom: 3px solid var(--clean-accent); }

    /* --- ãƒ‡ã‚¶ã‚¤ãƒ³: ç§‹ç”°ãƒ¢ãƒ€ãƒ³ --- */
    body.theme-akita { font-family: serif; background: var(--akita-cedar); background-image: linear-gradient(180deg, var(--akita-cedar) 0%, var(--bg-dark) 100%); color: #f0f6fc; }
    .theme-akita .container { max-width: 800px; width: 100%; background: var(--card-dark); padding: 30px; border: 1px solid var(--akita-gold); }
    .theme-akita h1, .theme-akita h2 { color: var(--akita-gold); text-shadow: 1px 1px 2px #000; }
    .theme-akita .tab { background: var(--akita-sea); color: var(--akita-gold); border: 1px solid var(--akita-gold); }
    .theme-akita .tab.active { background: var(--akita-gold); color: var(--akita-cedar); }
    .theme-akita input, .theme-akita select { background: #000; color: #fff; border: 1px solid var(--akita-gold); }
    .theme-akita button.main-submit { background: var(--akita-red); border-bottom: 4px solid #8e2a1e; }

    /* --- å…±é€š UI --- */
    .tabs { display: flex; gap: 8px; margin-bottom: 25px; }
    .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; transition: 0.2s; border-radius: 4px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9em; }
    input, select { width: 100%; padding: 12px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
    button.main-submit { width: 100%; padding: 15px; margin-top: 20px; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; font-size: 1.1em; }
    .theme-clean button.main-submit { background: var(--clean-main); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(128,128,128,0.2); }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
    .status-vacant { background: #e6fcf0; color: #2ea043; border: 1px solid #2ea043; }
    .status-busy { background: #fff1f0; color: #c0392b; border: 1px solid #c0392b; }

    /* --- ã™ã„ã¡ã‚ƒã‚“ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ UI --- */
    #chat-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
    #chat-bubble { width: 70px; height: 70px; background: white; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid var(--clean-main); overflow: hidden; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
    #chat-bubble:hover { transform: scale(1.1); }
    #chat-bubble img { width: 100%; height: 100%; object-fit: cover; }

    #chat-window { display: none; width: 350px; height: 550px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); border: 1px solid #ddd; flex-direction: column; overflow: hidden; }
    #chat-header { background: var(--clean-main); color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
    .theme-akita #chat-header { background: var(--akita-cedar); color: var(--akita-gold); border-bottom: 1px solid var(--akita-gold); }
    
    #chat-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; background: #fff; }
    .theme-akita #chat-content { background: #0d1117; }

    .msg-container { display: flex; align-items: flex-start; margin-bottom: 15px; width: 100%; }
    .bot-icon { width: 50px; height: auto; margin-right: 8px; flex-shrink: 0; border-radius: 50%; }
    .msg-bot { background: var(--sui-blue); color: #333; padding: 12px; border-radius: 15px; border-top-left-radius: 0; font-size: 0.85em; max-width: 70%; line-height: 1.4; }
    .theme-akita .msg-bot { background: #30363d; color: white; border: 1px solid var(--akita-gold); }
    .msg-user { background: var(--clean-main); color: white; padding: 10px; border-radius: 15px; border-bottom-right-radius: 0; margin-left: auto; max-width: 75%; font-size: 0.85em; }

    .faq-btn { width: 100%; padding: 10px; margin: 4px 0; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; text-align: left; font-size: 0.85em; transition: 0.2s; }
    .faq-btn:hover { background: var(--sui-blue); }
    .back-btn { background: none; border: 1px solid #666; color: #666; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-size: 0.75em; margin: 10px 0 0 58px; width: fit-content; }

    .chat-footer { background: var(--sui-blue); padding: 10px; }
    .theme-akita .chat-footer { background: var(--akita-cedar); }
    .input-row { display: flex; gap: 5px; background: white; padding: 5px; border-radius: 5px; }
    #userInput { flex: 1; border: none; padding: 5px; outline: none; margin: 0; background: transparent; color: #333; }
    .send-btn { background: var(--sui-pink); color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body class="theme-clean">

  <div class="theme-switcher"><button class="theme-btn" onclick="toggleTheme()">ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ</button></div>

  <div class="container">
    <div id="header-area">
      <div class="header theme-only-akita" style="display:none; text-align: center; margin-bottom: 20px; border-bottom: 3px double var(--akita-gold);">
        <h1>å‡ºç¾½é¯– - ç§‹ç”°ãƒãƒ¼ã‚¿ãƒ«</h1>
      </div>
      <div class="header-title theme-only-clean" style="text-align: center; font-size: 1.6em; font-weight: bold; margin-bottom: 25px;">å‡ºç¾½é¯– ç·åˆç”³è«‹ãƒãƒ¼ã‚¿ãƒ«</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="build">å»ºç¯‰ç”³è«‹</div>
      <div class="tab" data-tab="rentcar">è»Šä¸¡ãƒ¬ãƒ³ã‚¿ãƒ«</div>
      <div class="tab" data-tab="returncar">è¿”å´ãƒ»ç²¾ç®—</div>
      <div class="tab" data-tab="status">è²¸å‡ºçŠ¶æ³</div>
    </div>

    <div id="build" class="tab-content active">
      <h2>å»ºç¯‰ç”³è«‹æ›¸</h2>
      <form id="buildForm">
        <label>MCID</label><input type="text" name="mcid" placeholder="ä¾‹: Tarou_Akita" required>
        <label>å»ºç¯‰ç¨®åˆ¥</label><select name="type"><option>å»ºç‰©</option><option>é“è·¯</option><option>é‰„é“</option><option>ãã®ä»–</option></select>
        <label>ç”¨é€”</label><input type="text" name="purpose" placeholder="ä¾‹: è‡ªå®…ãƒ»å•†åº—" required>
        <label>ä¸­å¿ƒåº§æ¨™</label><input type="text" name="coords" placeholder="ä¾‹: 100, 64, -200" required>
        <button type="submit" class="main-submit">ç”³è«‹ã‚’æå‡ºã™ã‚‹</button>
      </form>
    </div>

    <div id="rentcar" class="tab-content">
      <h2>è»Šä¸¡ãƒ¬ãƒ³ã‚¿ãƒ«</h2>
      <form id="rentForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label><select name="number" id="carSelect"><option>èª­ã¿è¾¼ã¿ä¸­...</option></select>
        <button type="submit" class="main-submit">ãƒ¬ãƒ³ã‚¿ãƒ«ã‚’é–‹å§‹ã™ã‚‹</button>
      </form>
    </div>

    <div id="returncar" class="tab-content">
      <h2>è¿”å´ãƒ»æ–™é‡‘ç²¾ç®—</h2>
      <form id="returnForm">
        <label>MCIDï¼ˆæœ¬äººç¢ºèªï¼‰</label><input type="text" id="returnMcid" required>
        <label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label><select id="returnCarSelect"></select>
        <button type="button" onclick="calculateFee()" style="margin-top:10px;">æ–™é‡‘ã‚’ç®—å‡ºã™ã‚‹</button>
        <div id="calcResult" style="display:none; margin-top:15px; padding:15px; border:1px solid #ddd; background:rgba(0,0,0,0.05);">
          <div id="feeDetail"></div>
          <div id="feeTotal" style="font-size:1.4em; font-weight:bold; color:var(--sui-pink);"></div>
          <button type="submit" class="main-submit" style="background:var(--sui-pink);">è¿”å´ã‚’ç¢ºå®šã™ã‚‹</button>
        </div>
      </form>
    </div>

    <div id="status" class="tab-content">
      <h2>ç¾åœ¨è²¸å‡ºçŠ¶æ³</h2>
      <table>
        <thead><tr><th>ç•ªå·</th><th>è»Šç¨®</th><th>çŠ¶æ…‹</th></tr></thead>
        <tbody id="statusTable"></tbody>
      </table>
    </div>
  </div>

  <div id="chat-container">
    <div id="chat-bubble" onclick="toggleChat()">
      <img src="https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png" alt="ã™ã„ã¡ã‚ƒã‚“">
    </div>
    <div id="chat-window">
      <div id="chat-header"><span>å‡ºç¾½é¯–AIã‚¬ã‚¤ãƒ‰ã€Œã™ã„ã€</span><span onclick="toggleChat()" style="cursor:pointer">Ã—</span></div>
      <div id="chat-content">
        <div class="msg-container">
          <img src="https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png" class="bot-icon">
          <div class="msg msg-bot">ç”±åˆ©æœ¬è˜å¸‚AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ï¼æ‰‹ç¶šããªã©ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™ï¼</div>
        </div>
        <div id="faq-area" style="margin-left:58px;"></div>
      </div>
      <div class="chat-footer">
        <div style="font-size: 9px; color: #666; margin-bottom: 4px;">â€»å€‹äººæƒ…å ±ã¯å…¥åŠ›ã—ãªã„ã§ãã ã•ã„ã€‚</div>
        <div class="input-row">
          <input type="text" id="userInput" placeholder="è³ªå•ã‚’å…¥åŠ›...">
          <button class="send-btn" onclick="handleSend()">â–²</button>
        </div>
      </div>
    </div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwsq8vd69zZf5FsTUxfa26PS7mB3n8jJEuRJ_Xck68XRZvExMIW3gRxxCDU7KLiyHKH/exec";
const SUI_IMG = "https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png";
let currentRentData = [];
let currentFaqData = [];

// åˆæœŸãƒ­ãƒ¼ãƒ‰
function loadData() {
  fetch(GAS_URL + "?mode=carlist").then(res => res.json()).then(list => {
    currentRentData = list;
    const s1 = document.getElementById("carSelect");
    const s2 = document.getElementById("returnCarSelect");
    const tb = document.getElementById("statusTable");
    s1.innerHTML = ""; s2.innerHTML = ""; tb.innerHTML = "";
    list.forEach(item => {
      if(item.status === "è²¸å‡ºä¸­") {
        s2.innerHTML += `<option value="${item.number}">${item.number} (${item.car})</option>`;
      } else {
        s1.innerHTML += `<option value="${item.number}">${item.number} (${item.car}) - ${item.price}å††/æ—¥</option>`;
      }
      tb.innerHTML += `<tr><td>${item.number}</td><td>${item.car}</td><td><span class="status-badge ${item.status==='è²¸å‡ºä¸­'?'status-busy':'status-vacant'}">${item.status}</span></td></tr>`;
    });
  });

  fetch(GAS_URL + "?mode=faqlist").then(res => res.json()).then(faqs => {
    currentFaqData = faqs;
    showFaqMenu();
  });
}

// ãƒãƒ£ãƒƒãƒˆåˆ¶å¾¡
function toggleChat() {
  const win = document.getElementById('chat-window');
  win.style.display = (win.style.display === 'none' || win.style.display === '') ? 'flex' : 'none';
  if(win.style.display === 'flex') scrollToBottom();
}

function showFaqMenu() {
  const area = document.getElementById("faq-area");
  area.innerHTML = "";
  currentFaqData.forEach(f => {
    const b = document.createElement("button");
    b.className = "faq-btn"; b.textContent = "ğŸ“‹ " + f.question;
    b.onclick = () => askChat(f.question);
    area.appendChild(b);
  });
  scrollToBottom();
}

function askChat(q) {
  const content = document.getElementById('chat-content');
  const area = document.getElementById("faq-area");
  content.innerHTML += `<div style="width:100%; display:flex; margin-bottom:10px;"><div class="msg msg-user">${q}</div></div>`;
  area.innerHTML = "";

  const faq = currentFaqData.find(f => f.question === q);
  setTimeout(() => {
    content.innerHTML += `<div class="msg-container"><img src="${SUI_IMG}" class="bot-icon"><div class="msg msg-bot">${faq?faq.answer:'ã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'}</div></div>`;
    const back = document.createElement("button");
    back.className = "back-btn"; back.textContent = "â† ä»–ã®è³ªå•ã‚’ã™ã‚‹";
    back.onclick = showFaqMenu;
    content.appendChild(back);
    scrollToBottom();
  }, 600);
}

function handleSend() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if(!text) return;
  const content = document.getElementById('chat-content');
  content.innerHTML += `<div style="width:100%; display:flex; margin-bottom:10px;"><div class="msg msg-user">${text}</div></div>`;
  input.value = "";
  setTimeout(() => {
    content.innerHTML += `<div class="msg-container"><img src="${SUI_IMG}" class="bot-icon"><div class="msg msg-bot">ã€Œ${text}ã€ã«ã¤ã„ã¦ã§ã™ã­ã€‚ãƒœã‚¿ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰è¿‘ã„ã‚‚ã®ã‚’é¸ã‚“ã§ã„ãŸã ãã‹ã€ç®¡ç†ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠå°‹ã­ãã ã•ã„ï¼</div></div>`;
    showFaqMenu();
  }, 800);
}

function scrollToBottom() { const c = document.getElementById('chat-content'); c.scrollTop = c.scrollHeight; }

// ã‚¿ãƒ–ãƒ»ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab, .tab-content").forEach(el => el.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

function toggleTheme() {
  document.body.classList.toggle('theme-clean');
  document.body.classList.toggle('theme-akita');
  const isAkita = document.body.classList.contains('theme-akita');
  document.querySelectorAll('.theme-only-akita').forEach(e => e.style.display = isAkita ? 'block' : 'none');
  document.querySelectorAll('.theme-only-clean').forEach(e => e.style.display = isAkita ? 'none' : 'block');
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯
document.getElementById("buildForm").onsubmit = function(e) {
  e.preventDefault();
  fetch(GAS_URL, {method:"POST", body:new URLSearchParams(new FormData(this)).append("mode","build")}).then(() => alert("ç”³è«‹å®Œäº†ï¼"));
};
document.getElementById("rentForm").onsubmit = function(e) {
  e.preventDefault();
  const d = new URLSearchParams(new FormData(this)); d.append("mode","rent");
  fetch(GAS_URL, {method:"POST", body:d}).then(r=>r.text()).then(t => t.includes("Error")?alert("2å°ã¾ã§ã§ã™"):alert("ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹ï¼"));
};
function calculateFee() {
  const m = document.getElementById("returnMcid").value;
  const n = document.getElementById("returnCarSelect").value;
  const t = currentRentData.find(i => i.number == n);
  if(t && t.mcid === m) {
    const days = Math.max(1, Math.ceil(Math.abs(new Date() - new Date(t.lastDate))/(1000*60*60*24)));
    document.getElementById("feeDetail").innerHTML = `è»Šç¨®: ${t.car}<br>æœŸé–“: ${days}æ—¥é–“`;
    document.getElementById("feeTotal").innerText = `åˆè¨ˆ: ${days * t.price}å††`;
    document.getElementById("calcResult").style.display = "block";
  } else { alert("MCIDãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚"); }
}
document.getElementById("returnForm").onsubmit = function(e) {
  e.preventDefault();
  const d = new URLSearchParams(); d.append("mode","return");
  d.append("mcid", document.getElementById("returnMcid").value);
  d.append("number", document.getElementById("returnCarSelect").value);
  fetch(GAS_URL, {method:"POST", body:d}).then(() => location.reload());
};

document.getElementById("userInput").onkeypress = (e) => { if(e.key==="Enter") handleSend(); };
loadData();
</script>
</body>
</html>

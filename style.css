<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‡ºç¾½é¯– - ç·åˆç”³è«‹ãƒãƒ¼ã‚¿ãƒ«</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- ã“ã“ã«æœ€æ–°ã®CSSãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é©ç”¨ --- */
    :root {
      --akita-red: #c0392b;
      --akita-gold: #d4af37;
      --akita-cedar: #1b2e1b;
      --akita-sea: #0f172a;
      --bg-dark: #0d1117;
      --card-dark: #161b22;
      --clean-bg: #f3f6fb;
      --clean-main: #1c2a44;
      --clean-accent: #8c1f28;
      --sui-blue: #bce9fe;
      --sui-pink: #e91e63;
    }

    body {
      margin: 0; transition: 0.3s; min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding: 20px; font-family: "Noto Sans JP", sans-serif;
    }

    .theme-switcher { position: fixed; top: 8px; right: 8px; z-index: 10000; }
    .theme-btn { padding: 4px 10px; cursor: pointer; font-size: 11px; border-radius: 4px; opacity: 0.8; background: #fff; border: 1px solid #ccc; color: #333; }

    /* --- ãƒ†ãƒ¼ãƒï¼šã‚¯ãƒªãƒ¼ãƒ³ --- */
    body.theme-clean { background: var(--clean-bg); color: var(--clean-main); }
    .theme-clean .container {
      max-width: 800px; width: 100%; background: white;
      padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    .theme-clean .tab.active { color: var(--clean-accent); border-bottom: 3px solid var(--clean-accent); }
    .theme-clean .snow-icon::after {
      content: "â„"; position: absolute; top: 0px; right: 15px;
      color: var(--akita-gold); font-size: 1.6em; opacity: 0.8; pointer-events: none;
    }

    .header-title { position: relative; width: 100%; display: block; text-align: center; }

    /* --- ãƒ†ãƒ¼ãƒï¼šç§‹ç”°ãƒ¢ãƒ€ãƒ³ --- */
    body.theme-akita {
      background: var(--akita-cedar);
      background-image: linear-gradient(180deg, var(--akita-cedar) 0%, var(--bg-dark) 100%);
      color: #f0f6fc;
    }
    .theme-akita .container {
      max-width: 800px; width: 100%; background: var(--card-dark);
      padding: 30px; border: 1px solid var(--akita-gold); border-radius: 8px;
    }
    .theme-akita .tab { background: var(--akita-sea); color: var(--akita-gold); border: 1px solid var(--akita-gold); }
    .theme-akita .tab.active { background: var(--akita-gold); color: var(--akita-cedar); }
    .theme-akita input, .theme-akita select, .theme-akita textarea { background: #0d1117; border-color: #30363d; color: white; }

    /* --- å…±é€šUI --- */
    .tabs { display: flex; gap: 8px; margin-bottom: 25px; }
    .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; border-radius: 4px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
    textarea { height: 100px; resize: vertical; }

    /* --- ãƒœã‚¿ãƒ³ --- */
    button.main-submit {
      width: 100%; padding: 18px; margin-top: 20px; color: white; border: none;
      font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 1.1em;
      letter-spacing: 0.1em; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      position: relative; overflow: hidden;
    }
    button.main-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); filter: brightness(1.1); }
    .theme-clean button.main-submit { background: linear-gradient(135deg, var(--clean-main) 0%, #2c3e50 100%); }
    .theme-akita button.main-submit { background: linear-gradient(135deg, var(--akita-red) 0%, #a03026 100%); border: 1px solid var(--akita-gold); color: #fff; }

    /* --- ãƒ†ãƒ¼ãƒ–ãƒ« --- */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(128,128,128,0.2); }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; display: inline-block; min-width: 60px; text-align: center; }
    .theme-clean .status-vacant { background: #e6f7ff; color: #0070cc; border: 1px solid #91d5ff; }
    .theme-clean .status-busy { background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; }
    .theme-akita .status-vacant { background: rgba(212, 175, 55, 0.1); color: var(--akita-gold); border: 1px solid var(--akita-gold); }
    .theme-akita .status-busy { background: var(--akita-red); color: #ffffff; border: 1px solid var(--akita-red); }

    /* --- ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆUI --- */
    #chat-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; }
    #chat-bubble { position: fixed; bottom: 20px; right: 20px; width: 110px; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); filter: drop-shadow(0 6px 15px rgba(0,0,0,0.3)); z-index: 10002; }
    #chat-bubble img { width: 100%; height: auto; display: block; }
    #chat-bubble:hover { transform: scale(1.15) rotate(-8deg); }
    #chat-bubble.chat-open { width: 65px; bottom: 565px; right: 10px; opacity: 0.9; }
    #chat-window { display: none; width: 350px; height: 550px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); border: 1px solid #ddd; flex-direction: column; overflow: hidden; }
    #chat-header { background: var(--clean-main); color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
    .theme-akita #chat-header { background: var(--akita-cedar); color: var(--akita-gold); border-bottom: 1px solid var(--akita-gold); }
    #chat-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; background: #fff; }
    .theme-akita #chat-content { background: #0d1117; }
    .msg-container { display: flex; align-items: flex-start; margin-bottom: 15px; width: 100%; }
    .bot-icon { width: 45px; height: 45px; margin-right: 8px; flex-shrink: 0; border-radius: 50%; background: white; border: 1px solid #ddd; object-fit: cover; }
    .msg-bot { background: var(--sui-blue); color: #333; padding: 12px; border-radius: 15px; border-top-left-radius: 0; font-size: 0.85em; max-width: 70%; line-height: 1.4; }
    .theme-akita .msg-bot { background: #30363d; color: white; border: 1px solid var(--akita-gold); }
    .msg-user { background: var(--clean-main); color: white; padding: 10px; border-radius: 15px; border-bottom-right-radius: 0; margin-left: auto; max-width: 75%; font-size: 0.85em; }

    /* FAQãƒœã‚¿ãƒ³ */
    .faq-btn { width: 100%; padding: 10px; margin: 4px 0; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; text-align: left; font-size: 0.85em; transition: 0.2s; color: #333; }
    .faq-btn:hover { background: #f0faff; border-color: var(--sui-pink); }
    .faq-btn.category-btn { background-color: #f8fbff; border: 1.5px dashed #adc6ff; font-weight: bold; }
    .theme-akita .faq-btn.category-btn { background-color: rgba(212, 175, 55, 0.05); border: 1.5px dashed var(--akita-gold); color: var(--akita-gold); }
    .back-btn { background: #f0f0f0; border: 1px solid #ccc; color: #444; border-radius: 20px; padding: 6px 12px; cursor: pointer; font-size: 0.8em; margin: 5px 0; width: fit-content; transition: 0.2s; }
    .theme-akita .back-btn { background: #30363d; border-color: var(--akita-gold); color: var(--akita-gold); }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .chat-footer { background: var(--sui-blue); padding: 10px; }
    .theme-akita .chat-footer { background: var(--akita-cedar); }
    .input-row { display: flex; gap: 5px; background: white; padding: 5px; border-radius: 5px; }
    .theme-akita .input-row { background: #0d1117; border: 1px solid #30363d; }
    #userInput { flex: 1; border: none; padding: 5px; outline: none; margin: 0; background: transparent; color: #333; }
    .theme-akita #userInput { color: white; }
    .send-btn { background: var(--sui-pink); color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; }

    @media (max-width: 480px) { .tabs { flex-wrap: wrap; } .tab { font-size: 12px; padding: 8px; } #chat-bubble { width: 100px; } }
  </style>
</head>
<body class="theme-clean">

  <div class="theme-switcher">
    <button class="theme-btn" onclick="toggleTheme()">ãƒ‡ã‚¶ã‚¤ãƒ³åˆ‡ã‚Šæ›¿ãˆ</button>
  </div>

  <div class="container">
    <div class="header-title">
      <div class="theme-only-clean">
        <h1 style="margin:0; font-size: 1.5em;">å‡ºç¾½é¯– ç·åˆç”³è«‹ãƒãƒ¼ã‚¿ãƒ«<span class="snow-icon"></span></h1>
      </div>
      <div class="theme-only-akita" style="display:none;">
        <h1 style="margin:0; font-size: 1.5em; border-bottom: 2px double var(--akita-gold); padding-bottom: 5px;">å‡ºç¾½é¯– - ç§‹ç”°ãƒ¢ãƒ€ãƒ³</h1>
      </div>
    </div>

    <div class="tabs" style="margin-top:20px;">
      <div class="tab active" data-tab="build">å»ºç¯‰ç”³è«‹</div>
      <div class="tab" data-tab="rent">è»Šä¸¡ãƒ¬ãƒ³ã‚¿ãƒ«</div>
      <div class="tab" data-tab="return">è¿”å´ãƒ»ç²¾ç®—</div>
      <div class="tab" data-tab="manage">å¤‰æ›´ãƒ»äº‹æ•…</div>
    </div>

    <div id="build" class="tab-content active">
      <form id="buildForm">
        <label>MCID</label><input type="text" name="mcid" placeholder="Akita_Taro" required>
        <label>å»ºç¯‰ç¨®åˆ¥</label><select name="type"><option>å»ºç‰©</option><option>é“è·¯</option><option>ã‚¤ãƒ³ãƒ•ãƒ©</option></select>
        <label>ç”¨é€”</label><input type="text" name="purpose" placeholder="ä¾‹: ãã‚ŠãŸã‚“ã½å±‹" required>
        <label>ä¸­å¿ƒåº§æ¨™</label><input type="text" name="coords" placeholder="0, 0, 0" required>
        <button type="submit" class="main-submit">ç”³è«‹ã‚’é€ä¿¡ã™ã‚‹</button>
      </form>
    </div>

    <div id="rent" class="tab-content">
      <form id="rentForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>è»Šä¸¡é¸æŠ</label><select id="carSelect" name="number"></select>
        <button type="submit" class="main-submit">ãƒ¬ãƒ³ã‚¿ãƒ«ã‚’é–‹å§‹ã™ã‚‹</button>
      </form>
      <div id="status">
        <h3 style="margin-top:25px;">ç¾åœ¨ã®è²¸å‡ºçŠ¶æ³</h3>
        <table><thead><tr><th>ç•ªå·</th><th>è»Šç¨®</th><th>çŠ¶æ…‹</th></tr></thead><tbody id="statusTable"></tbody></table>
      </div>
    </div>

    <div id="return" class="tab-content">
      <form id="returnForm">
        <label>MCID</label><input type="text" id="returnMcid" required>
        <label>è¿”å´è»Šä¸¡</label><select id="returnCarSelect"></select>
        <button type="button" class="main-submit" onclick="calculateFee()">æ–™é‡‘ã‚’è¨ˆç®—ã™ã‚‹</button>
        <div id="calcResult" style="display:none; margin-top:15px; padding:15px; border:1px solid #ddd; border-radius:8px;">
          <p id="feeDetail" style="margin:0;"></p>
          <h2 id="feeTotal" style="margin:10px 0; color:var(--sui-pink);"></h2>
          <button type="submit" class="main-submit" style="margin-top:0;">è¿”å´ã‚’ç¢ºå®šã™ã‚‹</button>
        </div>
      </form>
    </div>

    <div id="manage" class="tab-content">
      <form id="manageForm">
        <label>MCID</label><input type="text" name="mcid" required>
        <label>å ±å‘Šã®ç¨®é¡</label>
        <select name="reportType" id="reportType" onchange="toggleManageFields()">
          <option value="change">å»ºç¯‰ç”³è«‹ã®å¤‰æ›´</option>
          <option value="delete">å»ºç¯‰ç”³è«‹ã®å–ã‚Šä¸‹ã’</option>
          <option value="accident">ã€é‡è¦ã€‘ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼ã®äº‹æ•…ãƒ»ç´›å¤±</option>
        </select>
        <div id="buildFields"><label>å¯¾è±¡ã®åº§æ¨™</label><input type="text" name="targetCoords"></div>
        <div id="carFields" style="display:none;"><label>è»Šä¸¡ãƒŠãƒ³ãƒãƒ¼</label><input type="text" name="carNumber"></div>
        <label>è©³ç´°å†…å®¹</label><textarea name="detail" required></textarea>
        <button type="submit" class="main-submit">å ±å‘Šã‚’é€ä¿¡ã™ã‚‹</button>
      </form>
    </div>
  </div>

  <div id="chat-container">
    <div id="chat-bubble" onclick="toggleChat()"><img src="https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png"></div>
    <div id="chat-window">
      <div id="chat-header"><span>å‡ºç¾½é¯–ã‚¬ã‚¤ãƒ‰ã€Œé»„æ¡œã™ã„ã€</span><span onclick="toggleChat()" style="cursor:pointer">Ã—</span></div>
      <div id="chat-content">
        <div class="msg-container"><img src="https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png" class="bot-icon"><div class="msg msg-bot">ãŠå›°ã‚Šã§ã™ã‹ãƒï¼Ÿè³ªå•ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div></div>
        <div id="faq-area"></div>
      </div>
      <div class="chat-footer"><div class="input-row"><input type="text" id="userInput" placeholder="è³ªå•ã‚’å…¥åŠ›..."><button class="send-btn" onclick="handleSend()">â–²</button></div></div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwsq8vd69zZf5FsTUxfa26PS7mB3n8jJEuRJ_Xck68XRZvExMIW3gRxxCDU7KLiyHKH/exec";
    const SUI_IMG = "https://i0.wp.com/kizakurasui.jp/wp-content/uploads/2019/03/-e1552528466283.png";
    let currentRentData = [];
    let currentFaqData = [];

    function loadData() {
      fetch(GAS_URL + "?mode=carlist").then(res => res.json()).then(list => {
        currentRentData = list;
        const s1 = document.getElementById("carSelect"); const s2 = document.getElementById("returnCarSelect"); const tb = document.getElementById("statusTable");
        s1.innerHTML = ""; s2.innerHTML = ""; tb.innerHTML = "";
        list.forEach(item => {
          if(item.status === "è²¸å‡ºä¸­") s2.innerHTML += `<option value="${item.number}">${item.number} (${item.car})</option>`;
          else s1.innerHTML += `<option value="${item.number}">${item.number} (${item.car}) - ${item.price}å††</option>`;
          tb.innerHTML += `<tr><td>${item.number}</td><td>${item.car}</td><td><span class="status-badge ${item.status==='è²¸å‡ºä¸­'?'status-busy':'status-vacant'}">${item.status}</span></td></tr>`;
        });
      });
      fetch(GAS_URL + "?mode=faqlist").then(res => res.json()).then(faqs => { currentFaqData = faqs; showFaqMenu(); });
    }

    function toggleChat() {
      const win = document.getElementById('chat-window'); const bubble = document.getElementById('chat-bubble');
      const isOpening = (win.style.display === 'none' || win.style.display === '');
      win.style.display = isOpening ? 'flex' : 'none';
      if(isOpening) { bubble.classList.add('chat-open'); scrollToBottom(); } else { bubble.classList.remove('chat-open'); }
    }

    function showFaqMenu(targetContainer = null) {
      const area = targetContainer || document.getElementById("faq-area");
      area.innerHTML = "";
      const categories = [...new Set(currentFaqData.map(f => f.category || "ãã®ä»–"))];
      categories.forEach(cat => {
        const b = document.createElement("button"); b.className = "faq-btn category-btn"; b.textContent = "ğŸ“ " + cat;
        b.onclick = () => showQuestionsByCategory(cat, targetContainer); area.appendChild(b);
      });
      scrollToBottom();
    }

    function showQuestionsByCategory(cat, targetContainer) {
      const area = targetContainer || document.getElementById("faq-area");
      area.innerHTML = `<div style="padding:5px; font-size:0.8em; color:#888;">ã‚«ãƒ†ã‚´ãƒª: ${cat}</div>`;
      currentFaqData.filter(f => (f.category || "ãã®ä»–") === cat).forEach(f => {
        const b = document.createElement("button"); b.className = "faq-btn"; b.textContent = "ğŸ“‹ " + f.question;
        b.onclick = () => askChat(f.question); area.appendChild(b);
      });
      const back = document.createElement("button"); back.className = "back-btn"; back.textContent = "â† åˆ†é¡ä¸€è¦§ã¸æˆ»ã‚‹";
      back.onclick = () => showFaqMenu(targetContainer); area.appendChild(back);
      scrollToBottom();
    }

    function askChat(q) {
      const content = document.getElementById('chat-content'); document.getElementById("faq-area").innerHTML = "";
      content.innerHTML += `<div class="msg-container" style="justify-content:flex-end;"><div class="msg msg-user">${q}</div></div>`;
      const faq = currentFaqData.find(f => f.question === q);
      setTimeout(() => {
        const responseId = "res-" + Date.now();
        content.innerHTML += `<div class="msg-container"><img src="${SUI_IMG}" class="bot-icon"><div class="msg msg-bot">${faq ? faq.answer : 'ã™ã¿ã¾ã›ã‚“ã€ã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'}</div></div><div id="${responseId}" style="margin-left:53px;"></div>`;
        addBackButton(responseId); scrollToBottom();
      }, 600);
    }

    function handleSend() {
      const input = document.getElementById("userInput"); const text = input.value.trim(); if(!text) return;
      const content = document.getElementById('chat-content');
      content.innerHTML += `<div class="msg-container" style="justify-content:flex-end;"><div class="msg msg-user">${text}</div></div>`;
      input.value = "";
      setTimeout(() => {
        const responseId = "res-send-" + Date.now();
        content.innerHTML += `<div class="msg-container"><img src="${SUI_IMG}" class="bot-icon"><div class="msg msg-bot">ã€Œ${text}ã€ã§ã™ã­ã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é¸ã¶ã‹é‹å–¶ã¾ã§ã€‚</div></div><div id="${responseId}" style="margin-left:53px;"></div>`;
        addBackButton(responseId); scrollToBottom();
      }, 800);
    }

    function addBackButton(targetId) {
      const nextArea = document.getElementById(targetId); const btn = document.createElement("button");
      btn.className = "back-btn"; btn.textContent = "â† ä»–ã®è³ªå•ã‚’ã™ã‚‹";
      btn.onclick = () => { btn.remove(); showFaqMenu(nextArea); }; nextArea.appendChild(btn);
    }

    function toggleManageFields() {
      const type = document.getElementById("reportType").value;
      document.getElementById("buildFields").style.display = (type === "accident") ? "none" : "block";
      document.getElementById("carFields").style.display = (type === "accident") ? "block" : "none";
    }

    function toggleTheme() {
      document.body.classList.toggle('theme-clean'); document.body.classList.toggle('theme-akita');
      const isAkita = document.body.classList.contains('theme-akita');
      document.querySelectorAll('.theme-only-akita').forEach(e => e.style.display = isAkita ? 'block' : 'none');
      document.querySelectorAll('.theme-only-clean').forEach(e => e.style.display = isAkita ? 'none' : 'block');
    }

    function calculateFee() {
      const m = document.getElementById("returnMcid").value; const n = document.getElementById("returnCarSelect").value;
      const t = currentRentData.find(i => i.number == n);
      if(t && t.mcid === m) {
        const days = Math.max(1, Math.ceil(Math.abs(new Date() - new Date(t.lastDate))/(1000*60*60*24)));
        document.getElementById("feeDetail").innerHTML = `è»Šç¨®: ${t.car}<br>åˆ©ç”¨æœŸé–“: ${days}æ—¥é–“`;
        document.getElementById("feeTotal").innerText = `åˆè¨ˆ: ${days * t.price}å††`;
        document.getElementById("calcResult").style.display = "block";
      } else { alert("MCIDãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚"); }
    }

    function scrollToBottom() { const c = document.getElementById('chat-content'); c.scrollTop = c.scrollHeight; }

    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab, .tab-content").forEach(el => el.classList.remove("active"));
        tab.classList.add("active"); document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    document.getElementById("buildForm").onsubmit = function(e) { e.preventDefault(); fetch(GAS_URL, {method:"POST", body:new URLSearchParams(new FormData(this)).append("mode","build")}).then(() => alert("ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚")); };
    document.getElementById("rentForm").onsubmit = function(e) { e.preventDefault(); const d = new URLSearchParams(new FormData(this)); d.append("mode","rent"); fetch(GAS_URL, {method:"POST", body:d}).then(r=>r.text()).then(t => t.includes("Error")?alert("2å°ã¾ã§ã§ã™"):alert("ãƒ¬ãƒ³ã‚¿ãƒ«ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚")); };
    document.getElementById("returnForm").onsubmit = function(e) { e.preventDefault(); const d = new URLSearchParams(); d.append("mode","return"); d.append("mcid", document.getElementById("returnMcid").value); d.append("number", document.getElementById("returnCarSelect").value); fetch(GAS_URL, {method:"POST", body:d}).then(() => location.reload()); };
    document.getElementById("manageForm").onsubmit = function(e) { e.preventDefault(); const d = new URLSearchParams(new FormData(this)); d.append("mode", "manage"); fetch(GAS_URL, {method: "POST", body: d}).then(() => { alert("å ±å‘Šã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚"); this.reset(); }); };
    document.getElementById("userInput").onkeypress = (e) => { if(e.key==="Enter") handleSend(); };

    loadData();
  </script>
</body>
</html>
